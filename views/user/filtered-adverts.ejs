<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head') %>
</head>
<body>
    <%- include('../partials/navbar') %>
    
    
    
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <h1 class="text-light text-center my-3">İlanlar Sayfası</h1>
                <!-- navs and tabs -->
                <ul class="nav justify-content-center text-light bg-danger">
                    <li class="nav-item">
                      <a class="nav-link active" aria-current="page" href="/adverts/customer">Taşınacak Yük Arıyorum</a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" href="/adverts/shipper">Nakliyeci Arıyorum</a>
                    </li>
                </ul>
                <!-- advert-filter -->
                <div class="row my-3">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <form id="advertsFilter" action="/adverts/<%= advertType=="customer" ? "customer" : "shipper" %>" method="post">                                        
                                    <div class="row ">
                                        <!-- startPoint Selector -->
                                        <div class="col-md-3">
                                            <label for="startPointSelector" class="form-label border-bottom">Başlangıç Noktası</label>
                                            <select class="form-select form-select-sm mb-3" aria-label=".form-select-sm example" name="startPoint" id="startPointSelector" required>
                                                <% provinces.forEach(province => { %>
                                                    <option value="<%= province.id %>" <%= startPoint == province.id ? 'selected' : '' %>><%= province.name %></option>
                                                <% }) %>
                                            </select>
                                        </div>
                                        <!-- endPoint Selector -->
                                        <div class="col-md-3">
                                            <label for="endPointSelector" class="form-label border-bottom">Bitiş Noktası</label>
                                            <select class="form-select form-select-sm mb-3" aria-label=".form-select-sm example" name="endPoint" id="endPointSelector" required>
                                                <% provinces.forEach(province => { %>
                                                    <option value="<%= province.id %>" <%= endPoint == province.id ? 'selected' : '' %>><%= province.name %></option>
                                                <% }) %>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="startDatePicker" class="form-label border-bottom">Başlangıç Tarihi</label>
                                            <input type="date" class="form-control" name="startDate" id="startDatePicker" value="<%= startDate %>" required> 
                                        </div>
                                        <div class="col-md-2">
                                            <button type="submit" id="filterAndSearchBtn" class=" btn btn-sm btn-outline-danger px-3" style="margin-top: 36px;">Ara</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- adverts -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <% if (advertType=="customer") { %>  
                                <% if (adverts) { %>                                 
                                    <% adverts.forEach(advert => { %>                                 
                                        <div class="accordion advert-card" id="accordion_<%= advert.id %>">
                                            <div class="accordion-item my-2">
                                                <div class="row">
                                                    <h2 class="accordion-header" id="headingOne">
                                                        <button class="accordion-button collapsed bg-danger text-light" type="button" data-bs-toggle="collapse" data-bs-target="#advertId_<%= advert.id %>" aria-expanded="true" aria-controls="advertId_<%= advert.id %>">
                                                            <%= advert.title %>
                                                        </button>
                                                    </h2>
                                                    <div class="row mx-3 my-4">
                                                        <!-- start point to end point -->
                                                        <div class="col-md-4">
                                                            <h4>
                                                                <span>
                                                                    <% const foundStartPoint = provinces.find(province => province.id == advert.startPoint); %>
                                                                    <%- foundStartPoint ? `<b>${foundStartPoint.name}</b>` : "Bulunamadı"; %>
                                                                </span>
                                                                <i class="fa-solid fa-arrow-right"></i>
                                                                <span>
                                                                    <% const foundEndPoint = provinces.find(province => province.id == advert.endPoint); %>
                                                                    <b>
                                                                        <%- foundEndPoint ? `${foundEndPoint.name}</b>` : "Bulunamadı"; %>
                                                                    </b>
                                                                </span>
                                                            </h4>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <h5><span class="startDate"><%= advert.startDate %></span> - <span class="endDate"><%= advert.endDate %></span></h5>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <p><%= advert.cargo.cargoType.cargoTypeName %></p>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <button type="submit" class="btn btn-sm btn-danger" id="advertDetailBtn" data-bs-toggle="collapse" data-bs-target="#advertId_<%= advert.id %>" aria-expanded="false" aria-controls="advertId_<%= advert.id %>">
                                                                Detayları Göster</button>
                                                        </div>
                                                    </div>
                                                </div>
                                              <div id="advertId_<%= advert.id %>" class="accordion-collapse collapse " aria-labelledby="headingOne" data-bs-parent="#accordion_<%= advert.id %>">
                                                <div class="accordion-body">
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="row mb-3">
                                                                <h6 class="text-muted"><b>İlan Açıklaması</b></h6>
                                                                <hr>
                                                                <p><%- advert.description %></p>
                                                            </div>
                                                            <div class="row mb-3">
                                                                <h6 class="text-muted"><b>Kargo Bilgileri</b></h6>
                                                                <hr> 
                                                                <table class="table table-bordered">
                                                                    <thead>
                                                                      <tr>
                                                                        <th scope="col">Kargo Türü</th>
                                                                        <th scope="col">Kilo</th>
                                                                        <th scope="col">Boy (uzunluk X genişlik)</th>
                                                                        <th scope="col">Kargo Görseli</th>
                                                                      </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                      <tr>
                                                                        <th scope="row"><%= advert.cargo.cargoType.cargoTypeName %></th>
                                                                        <td><%= advert.cargo.weight %> kg</td>
                                                                        <td><%= advert.cargo.verticalHeight %>cm X <%= advert.cargo.horizontalHeight %></td>
                                                                        <td><img src="/static/images/<%= advert.cargo.cargoImg %>" alt="<%= advert.cargo.cargoImg %>" style="width: 80px;"></td>
                                                                      </tr>
                                                                    </tbody>
                                                                  </table>
                                                            </div>
                                                            <div class="row mb-3">
                                                                <h6 class="text-muted"><b>Kargo Teslim Tarihi Aralığı</b></h6>
                                                                <hr> 
                                                                <p>

                                                                    Başlangıç Tarihi: <span class="startDate"><%= advert.startDate %></span> - Bitiş tarihi: <span class="endDate"><%= advert.endDate %></span>
                                                                </p>
                                                            </div>
                                                            <div class="row mb-3">
                                                                <div class="col-md-12">
                                                                    <button type="submit" class="btn btn-outline-danger float-end">Teklif Gönder</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>    
                                                </div>
                                              </div>
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <h1>İlan Bulunamadı</h1>
                                <% }%>                          
                            <% } %>
                            <% if (advertType=="shipper") { %>
                                <% if (adverts) { %>
                                    
                                    <% adverts.forEach(advert => { %>   
                                        <div class="accordion advert-card" id="accordion_<%= advert.id %>">
                                            <div class="accordion-item my-2">
                                                <div class="row">
                                                    <h2 class="accordion-header" id="headingOne">
                                                        <button class="accordion-button collapsed bg-danger text-light" type="button" data-bs-toggle="collapse" data-bs-target="#advertId_<%= advert.id %>" aria-expanded="true" aria-controls="advertId_<%= advert.id %>">
                                                            <%= advert.title %>
                                                        </button>
                                                    </h2>
                                                    <div class="row mx-3 my-4">
                                                        <!-- start point to end point -->
                                                        <div class="col-md-4">
                                                            <h4>
                                                                <span>
                                                                    <% const foundStartPoint = provinces.find(province => province.id == advert.voyage.route.startPoint); %>
                                                                    <%- foundStartPoint ? `<b>${foundStartPoint.name}</b>` : "Bulunamadı"; %>
                                                                </span>
                                                                <i class="fa-solid fa-arrow-right"></i>
                                                                <span>
                                                                    <% const foundEndPoint = provinces.find(province => province.id == advert.voyage.route.endPoint); %>
                                                                    <%- foundEndPoint ? `<b>${foundEndPoint.name}</b>` : "Bulunamadı"; %>
                                                                </span>
                                                            </h4>
                                                        </div>
                                                        <div class="col-md-3">
                                                            
                                                            <h5><span class="startDate"><%= advert.voyage.startDate %></span> - <span class="endDate"><%= advert.voyage.endDate %></span> </h5>
                                                            
                                                        </div>
                                                        <div class="col-md-3">
                                                            <p><%= advert.voyage.vehicle.vehicleType.vehicleTypeName %></p>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <button type="submit" class="btn btn-sm btn-danger" id="advertDetailBtn" data-bs-toggle="collapse" data-bs-target="#advertId_<%= advert.id %>" aria-expanded="false" aria-controls="advertId_<%= advert.id %>">İncele</button>
                                                        </div>
                                                    </div>
                                                </div>
                                              <div id="advertId_<%= advert.id %>" class="accordion-collapse collapse " aria-labelledby="headingOne" data-bs-parent="#accordion_<%= advert.id %>">
                                                <div class="accordion-body">
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="row mb-3">
                                                                <h6 class="text-muted"><b>İlan Açıklaması</b></h6>
                                                                <hr>
                                                                <p><%- advert.description %></p>
                                                            </div>
                                                            <div class="row mb-3">
                                                                <h6 class="text-muted"><b>Araç Bilgileri</b></h6>
                                                                <hr> 
                                                                <div class="col-md-4">
                                                                    Araç Markası: <b><%= advert.voyage.vehicle.brand %></b>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    Kapasite: <%= advert.voyage.vehicle.capacity %> Kg
                                                                </div>
                                                                <div class="col-md-3">
                                                                    Teker Sayısı: <%= advert.voyage.vehicle.wheels %> 
                                                                </div>
                                                                <div class="col-md-3">
                                                                    Araç Türü: <%= advert.voyage.vehicle.vehicleType.vehicleTypeName %> 
                                                                </div>
                                                            </div>
                                                            <div class="row mb-3">
                                                                <h6 class="text-muted"><b>Sefer/Güzergah Bilgileri</b></h6>
                                                                <hr> 
                                                                <p>
                                                                    <b class="text-success">
                                                                        
                                                                        <%- foundStartPoint ? `<b>${foundStartPoint.name}</b>` : "Bulunamadı"; %>
                                                                    </b> 
                                                                    <i class="fa-solid fa-arrow-right"></i>
                                                                    <% if (advert.voyage.route.visitPoints) { %>
                                                                        <% for (let visitPoint of advert.voyage.route.visitPoints) { %>
                                                                            <% const findVisitPoint = provinces.find(province => province.id == visitPoint); %>
                                                                            <%- findVisitPoint ? `${findVisitPoint.name}` : "Bulunamadı"; %>
                                                                            <i class="fa-solid fa-arrow-right"></i>
                                                                        <% } %>
                                                                    <% } %>
                                                                    <b class="text-danger">
                                                                        
                                                                        <%- foundEndPoint ? `<b>${foundEndPoint.name}</b>` : "Bulunamadı"; %>
                                                                    </b>  
                                                                </p>
                                                            </div>
                                                            <div class="row mb-3">
                                                                <div class="col-md-12">
                                                                    <button type="submit" class="btn btn-outline-danger float-end">Teklif Gönder</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>    
                                                </div>
                                              </div>
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <h5 class="bg-danger">İlan Yok</h5>
                                    <% } %>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
         
    <%- include('../partials/script') %>
    <script src="/static/js/dateFormatConvertor.js"></script>
    
    <script>
        const startPointSelector=document.getElementById("startPointSelector");
        const endPointSelector=document.getElementById("endPointSelector");
        const startDatePicker=document.getElementById("startDatePicker");
        const filterAndSearchBtn=document.getElementById("filterAndSearchBtn");
        let startPoint;
        let endPoint;
        let startDate;
        startPointSelector.addEventListener("change",()=>{
            startPoint=startPointSelector.value;
        });
        endPointSelector.addEventListener("change",()=>{
            endPoint=endPointSelector.value;
        });
        startDatePicker.addEventListener("change",()=>{
            startDate=startDatePicker.value;
        });      
        let advertsFilter=document.getElementById("advertsFilter");
        let advertsFilterStatic=advertsFilter.action;
        console.log(advertsFilterStatic);
        filterAndSearchBtn.addEventListener("click",()=>{
            advertsFilter.action=`${advertsFilterStatic}/${startPoint}-${endPoint}/${startDate}`;
        })

    </script>
</body>
</html>